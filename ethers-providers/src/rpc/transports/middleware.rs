use bytes::Bytes;
use std::collections::HashMap;

use crate::{
    rpc::transports::http::{ClientError, Provider},
    HttpClientError::{MiddlewareError, ReqwestError},
};
use anyhow::anyhow;
use http::response::Builder;
use reqwest::{Body, Response, StatusCode};
use reqwest_chain::Chainer;
use reqwest_middleware::Error;
use url::Url;

/// Middleware for switching between providers on failures
pub struct SwitchProviderMiddleware {
    /// Providers for the url
    pub providers: Vec<Url>,
}

#[derive(Default, Debug)]
pub struct LocalState {
    pub active_provider_index: usize,
    pub prev_stat: HashMap<usize, Option<ClientError>>,
}

impl SwitchProviderMiddleware {
    pub fn _new(providers: Vec<Url>) -> Self {
        Self { providers }
    }
}

#[async_trait::async_trait]
impl Chainer for SwitchProviderMiddleware {
    type State = LocalState;

    async fn chain(
        &self,
        result: Result<reqwest::Response, Error>,
        _state: &mut Self::State,
        request: &mut reqwest::Request,
    ) -> Result<Option<reqwest::Response>, Error> {
        let mut next_state = |client_error: Option<ClientError>| {
            let active_index = _state.active_provider_index;
            _state.prev_stat.insert(active_index, client_error);
            let next_index = _state.active_provider_index + 1;
            if next_index >= self.providers.len() {
                return Err(anyhow!("Exiting Middleware"))?;
            }
            _state.active_provider_index = next_index;
            let next_provider = self.providers[next_index].clone();
            let url_ref = request.url_mut();

            *url_ref = next_provider.clone();
            log::trace!(target:"ethers-providers", "Retrying request with new provider {next_provider:?}");
            Ok::<_, anyhow::Error>(())
        };

        match result {
            Ok(mut response) => {
                if response.status() != StatusCode::OK {
                    match response.error_for_status_ref() {
                        Ok(_res) => (),
                        Err(err) => {
                            let _ = next_state(Some(ReqwestError(err)))?;
                            return Ok(None);
                        }
                    }
                };

                let mut body_vec = Vec::new();
                while let Some(chunk) = response.chunk().await? {
                    body_vec.extend_from_slice(&chunk);
                }

                let body = Bytes::from(body_vec);

                match serde_json::from_slice(&body) {
                    Ok(crate::rpc::common::Response::Success { result: _, .. }) => {
                        let http_response = Builder::new().status(200).body(body.clone()).unwrap();
                        return Ok(Some(reqwest::Response::from(http_response)));
                    }
                    Ok(crate::rpc::common::Response::Error { error, .. }) => {
                        let _ = next_state(Some(ClientError::JsonRpcError(error)))?;
                    }
                    Ok(_) => {
                        let err = ClientError::SerdeJson {
                            err: serde::de::Error::custom(
                                "unexpected notification over HTTP transport",
                            ),
                            text: String::from_utf8_lossy(&body).to_string(),
                        };
                        let _ = next_state(Some(err))?;
                    }
                    Err(err) => {
                        let error = ClientError::SerdeJson {
                            err,
                            text: String::from_utf8_lossy(&body).to_string(),
                        };

                        let _ = next_state(Some(error))?;
                    }
                };
            }
            Err(e) => {
                log::trace!(target:"ethers-providers", "Possibly encountered an os error submitting request, switching provider {e:?}");
                let _ = next_state(None)?;
            }
        }

        Ok(None)
    }

    fn max_chain_length(&self) -> u32 {
        let provider_len = self.providers.len() as u32;
        provider_len + 1
    }
}

#[cfg(test)]
mod test {
    use crate::{rpc::common::Request, Http};
    use bytes::Bytes;
    use reqwest::Url;
    use std::fmt::Pointer;

    #[tokio::test]
    async fn test_switch_provider_middleware_for_json_get_block_by_number() {
        let providers = vec![
            Url::parse("http://localhost:3500").unwrap(),
            Url::parse("https://www.noderpc.xyz/rpc-mainnet/public").unwrap(),
        ];

        let http_provider = Http::new_client_with_chain_middleware(
            Url::parse("http://localhost:3500").unwrap(),
            providers,
        );

        let block_num = "0x12c1bc8";
        let txn_details = false;
        let params = (block_num, txn_details);

        let payload = Request::new(0, "eth_getBlockByNumber", params);

        let res = http_provider
            .client()
            .post("https://docs-demo.quiknode.pro/")
            .json(&payload)
            .send()
            .await
            .unwrap();

        let expected_response = r#"{"jsonrpc":"2.0","id":0,"result":{"baseFeePerGas":"0x32842990b","blobGasUsed":"0x0","difficulty":"0x0","excessBlobGas":"0x60000","extraData":"0x6265617665726275696c642e6f7267","gasLimit":"0x1c9c380","gasUsed":"0xf79bd8","hash":"0xeaa2ba3e0a10c0edabeb143a0b24b16cb4752dd4a187f192acdb94db01a89fb4","logsBloom":"0x1f674c368127474c1021a670cc180e23bcde0631dc724cc00e818128fcb4f70a84074db4a640a7b7c2519949683753232ee98ae99e3b6d08ea217d6925ee6d9a7012c0195c1c8cdbec8ec3ecee612220a88c0a20b6e70ecc55b21660e7211829c4eec5658e4e642d1b4fc097a900ec59a39117c32abf065692259ff4dd6a91850fe2065c6a64884c88c6a38cb67a900362192e41c720c388c66b4afc6ad65059ffef84cbe8b92fb673f516c60953dd9285e5f629c0b85aca88eef50630b9b1788506119be4d022158eca071c63775aeab36cb992e5af305e61b7543a5e9ae0ca4438e0a798864d02539c9adfad219354a0a5d31cc198e770ab4b2830b341dc8c","miner":"0x95222290dd7278aa3ddd389cc1e1d165cc4bafe5","mixHash":"0x37e8f47188206056d6d53ee7baa4431eb3ab3013473e691fb2c6cd036da8e557","nonce":"0x0000000000000000","number":"0x12c1bc8","parentBeaconBlockRoot":"0x8418e4d7c9e0be889dfbb3fa6f1fc248d3073d87920ce140f31fe04e452f4dfc","parentHash":"0xb12b89d44c6d2ac5d4dc0d0f48b7f2beb3d915e31ca91f22884d19486a4c20d7","receiptsRoot":"0x1e0c72f0756601722bf66d94cff062e4f30685b9560a129fa89fc09f8594ebd0","sha3Uncles":"0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347","size":"0x197a5","stateRoot":"0x3a011b6b9539af20187d0b1766dfe3e9271d5deeb202ef43af3604e697f75d88","timestamp":"0x661e68c3","totalDifficulty":"0xc70d815d562d3cfa955","transactions":["0xfe2eda912ae0307ecf732e4a2f63e8b00554b64be1bb94f58dbdc4813dfc4937","0x35ab39adf4a28b005a8f0c1d34907cef9ab48fdab6a5714fc9fe61cf89df8eda","0x51d4722b986a7d64be876e9c4699482ed1397ff547839bbc837a635ce18992fb","0x2f55d5586e6c2ac488bd763618d37540951b7f7c12443946c77941f17147abeb","0xa93be01d0d41ae8dca42c2c7e6b54177b3a9f6032ab4123442c257efea52b1ef","0x12b4eef48f278306ec14cd6131f29570ac7c9cd218d47a4309c25e863fa09516","0x1edee3af6fba3e5a5ae164482a534cc8d3627d4a33efee6b80db779c86b5959c","0x6f226a1524508dc2d2ca3dc55ced337786884af1b38a71358e4e5d3ecb8c0785","0x3e948bb6d5e2dab692c9051978a1caaaa6ca149c3eb0c925d0c0e40c1ddacb9b","0x56e10d8837ef3d1f4451ddfc7f3c27ac094e30b3e0998b8efa751f7df759d5d4","0x47c1e8b8e0bfeb2b64af76d09e494c73322700c593e219e1fbab76a5d1310799","0x01eb3d1b442eeec9c08c9cc8ec39401e160b37751910de0418e6747638e02f33","0x28ea9b64ac52ab564fbdaef5a57252a95e0c7373c70c67f7b1949c4ddf5f3fe2","0x14e3e032a14cece01f2bc45a3b2c770db89308fdb2fa4fca8921915a8fc114d7","0x9cfb91852470e72000a52b268537f57c3f32aefbcd9ebe7984c37853a5228031","0xdd050b3d35bea701aa1d7ac9761cbd994a73ddf5e15b5a09adb4992afbdc8333","0x08cb5ca4155552059eef6a3e197dded27f12d319044bb3996d66bf4a15327bb5","0x2c5964ab47dfaf321e31628a554a50cf0b0c8ee1abd2c1cd5994f28d2f400f20","0xe4063a4ba6b41d6fed89bf4b8da6ea03e65578f724ff571879902e64008beadc","0xb35fa624b060e5eb9b1d154c5f4a276f4084909751871f8d4b0a712cff8e6f96","0x82cff9aa2957843638df6989aa5cff5e33166e530d0495312416b819c5658db2","0x7e0e774990f4fcb2f46550750a7e0237c97ca67570e8500ebf9f38308abcce33","0xea1822763499743b5e23ca8fa3085496577bbc73a2d21a0dabc798132d32a3c8","0x1835f301176958aa8b5163820da6f4c3cff37df2fa00751f1244552f60167004","0x90052dd4360d061c988a854a4bfe2cfdafc10036c298c6bb32bf23f9cb3b6d4c","0xb1fe34f2ab44b04c819cbc699bf826d68bff7816276518c32ecaa825a1654490","0xf8487bd357d97bcd50efd65be54ed430a8dc84d340795b2d1eb22dec96d739f8","0x3ce1e3598c47371907015ea8be9c9e506495bafd0fe8cde8f6550520ba93a96a","0x2d79273525d6e7fc3dc83c2ff40e6e935fb35c2ce856ad904d24e7370f15d79b","0xfa9159e84bf69754b232839ea1ca192eed90302908c4a3d399c05b0c39b7f4ec","0x03487de65d3593be86d0838e055dc36b735ce520aaf8064e378a6248d45a2d2d","0x178a165642183bc9e7c31173d7327138c1ee2fbd8df7c8195a0ebc470abac437","0xc9f5acd7c41afa64ab55849be91e6ec7f7796760d7f49695fe1cd15d2f308d82","0xc69450ae9c00bfa5f535ee4c74df077dd70fb58ff3474bac060e0942941baddb","0xc7b4fc580126a8187a71ac3dee808099fe0c7da7238b62de00630ecb92b935a9","0xe177660ac9060a9b508df474bfcd5f66a71a770f09a196ccbe8725a9d20d7ebe","0xf7d45126f5dbe2c4a20c1d0d7c2a362ed2c9d7c36670acd64f85fcb18bc6eb7f","0x4e5311c023f038cd536b043162dc6f69a370d8d82965c527b206b71cfb316fa5","0x0715cfb7a573c018388c785f392bc79ba6bcc32fb7dadf57241e56d54aca2f66","0x2de2b790ca134784053a59e060edf4838b2f69e7ac3543586090eef819f4c9aa","0x40e32d706f4282dbbecd1b84441ace3ce006f8bd703e6644065a6f59d07fb7d5","0x5f06a724e92cbf7d96ddd5223fea39485f12628ffe6e324d2ca38398a047ef14","0x1c7a9ac0897660cd2d790e281e1d659c4f0c0909a8aad9e5cb378f253dab20a9","0x1f8c93893b7447e19662db5ff67f1692b979da6f08822c864f2407573a19079e","0xe618106bee9237931df621252748672f5aa9d329f5086675dcf6c3695118d95a","0x6e6d8593de0cb669a6a11bc4c0437ee8b6f9343017aa2c979e35faf8c2ded81d","0x1501ee20fb2f19d78e2015a9b6e976283dd5a06a28bc0333d1a84120f9e43c53","0xd4d41e4670cc4884c816923a256a0a25b6595c6396381f35af39bea7fac99201","0xd146e6bc657cbfbe5826c3f5ef232b6aaac3a77d13bfd2df147efc44802729f5","0xf8f7c4e6e41d956f6b0be45eb35a5f745263d78bf6647d6b524924fcfd64d4c6","0x58d692b122e3e176c1ba8ea704c97d4d2229d94da342f6c25e9fc9956d0c138b","0x24e5c303b8fe13e82dc424b25ac05c2745127ce18db3f5dbe44ab2958c1ff309","0x792a703a4b43777e57ddbdd6e7cc4bd103c5d614d193fb8a43730c74e074a981","0x54062c277561682ed020645327c3e49085efcc251e33a05af8149eebf247922a","0x1af6f54db351f9f3a41cb37bdcd1e3f1c8bd48a55ba4edc9e8bd8812f51c41fe","0xf87552952c32f85c6e61de181127e4b99e01111a9813e6087131cd0333378bc2","0xae31459cb58ed8774d4b0b627cdaa6bfe06c70a21b9836f82919808e3947d098","0xd9199bc984a780e51341ff025665cb21fdf68ef94ecbdb963b6393ecbf2bbeb6","0x1bc0ffa48fac8ec8462e755eca329002b99d59c273361d4548f045a63a6b2e7b","0x79b9393d49f152c97d836ca093c31328dea8d448d62c861257a0db3e0253b240","0x16f79bfb4673f4efc69df8a24485d6f699f3e8ec3a45483f5109e73056b685b2","0x0bc1ab7ed01100acad9e68f2186a0242a34c9a32234061ce70000856f43f6b7b","0x8865a59fa1419e54354ba4a7202eba6b851425cebe7bea870dc3c6a7816a2086","0x5ac773bbcb5976b25a79ead50a234adfb8d1b5015c7c5f5877d9ed54fb40f859","0xc070206ea83b7b193f71fdd76e63d16e052161182f689e29061954061c5264f3","0x3705d7f96c6bfaffbdecc66c5a009d79989d76d9a97b4a893999eaaf26dff957","0x43dcd1727ea6bc59e853f5eeb459c7c630a424fb54ca1a9455bc9439028f3684","0x9c0134d2560a8d12e751320a9b2083bd5f66f959eff215c9d16ef3fa6d5e973d","0x11e0cb80b3ab5580d12525419d3f726d0187d9607b1134cd0f8051334127ce5e","0x3931d244d63a0337882392462f364cef42f1e0a6b7f016025d5c776f25415774","0xeed0328c8642736ed9b74a95245da7876daf04f50f62aa78de30a7583f9fb8aa","0x5a03a6f0fb837e131b354e9b293328d66b7646f8af2896d9f746d65e6ae41a5b","0x0cfd5020fbd371f3a26d74c4123c042f5af04e3fa12fc684aa5709e379b0879c","0x80630d29093edcd0042adaa5c638e75883a19d49894f6979c900232811a15427","0x76d209fe08efe0d6d278d9a8c1d2036ba259c8f78d2a3d7a420cfa45fa9916d2","0x3398ff3128cec4a21b14349f587a5adcbb9cce80f8ec09bb6edf7ba2c61302c0","0xf174627eb7aee1877c9cd4dc1cde4745a3d98efab35c3f0489187066f6ce21ab","0x0139540c73c5182b817965047c99e5dc61e51695d35ccc0d5d58fd5eab042a36","0xf0b473bb154d4ba751465d99b8d3e5856bb83ef832a10963411efe76abaf4b00","0x35eb5ddc8562799eccf6aa798876fe55ca21d4fe94c907607a94360082ad9885","0x1e3c06c98c571fa3a0f24de6fb9819b2b1eaf1833ca08743c989f4920feaa270","0xda6b46c679b68df6a302fac459bea52399e2674b237ca85eec045080905fb5db","0x30c514ebae9fff745b50ead6208ae2ab3ce5d524ec988c7087d2c59af11a074b","0x8d3a4c6168add42211e26d5709b53e3801315710b4d32de30e8f38cca6d67e3b","0xa73109d0303a22c31aff5820d1dff6274b5f37b092df748b29e9095d1a976060","0x6f8ac91cc6755bdb788c6ea327d5c21da60fd79074d4273a5b49f07c14f378b6","0x0c872fbd9043413407c9594923eeca3a74bc93c201c6c08882ff4a3f3ae36ba7","0x5bb677857ffbae0c1d959d65611e1a56f2335e8ec5f3b4efebbfbd962ae41c41","0x744072ccc65a9b4db7823c129056cef350349543dda01b61b2eacd3c0dce71e3","0x293fdbe3acbcf8657d0ea37d00c8832c27f5565a87755d49eeefc99d5a2dc55a","0x12f2058e090f0625da105555b859ddf4156a9e71859a225edeb013e106baacc8","0xa048f434a327b28199360752268bdb36f654668f70c5d0db49be90db3034e202","0xef6c7c017ef4d92bde387c4b446c7f8bb8b1667b7ad0226f79e0f9eeda7190c8","0xc75f8e5e456968f1dc1dcb77ac10a2081151b4d5e2e9a38d0f745c9fb258e33d","0x6818936ee60aee4c75c42b980af0f5d3fb3e9e272c28013d46878d39ea43cbd8","0x1d9e33f779bc904a18b8d8c46a83bcbcaad3eccafe1dc9ab1267827039c0e023","0x467f26bae67bc4cf275b1dc155681732337a6493c7433b1f49814f72bfd0ab99","0x50018cf80a0277d876e20e884d9d9f2caacbb93d61e122b16adbf72798a3cd1c","0x0c941b2ccc34629bae84881ec8445f1c18dd9ae9a830841695d2253f51ea5fe8","0x990eb65d9f9ee682371d7acfbacd10b86252886d929fc3f18d889f309e4baab9","0xf8ab87ca9e3217094a7187a1073dc55fb93c7abb4e285cec9aca5d628203b3ee","0x287b261d204970aeb90cf5635150ce3d80e5b08fa58ffd4fed6ae1b89ff89559","0xa49bf993f0177d73b93ea32aad884516bc1ce2a9dacfdb56702315856f6b2dae","0x2e8ec668f2ff4ab75ff93677dd6d9ccbe003d8e92bca40defcfbcc404b2cee20","0x2e291fe90f5a8d523298af9c82615836c71c65c4e6df703cd458cc8e3d55fa39","0x6a3d193ec13abe2c2959fba5ef3da048515e43c1ff3c404c3f462847addfe29d","0x721b0a8abbe943603fd2a0bc4d343c89770fef10dc22dd29300e0fd375d7980a","0x9382ca7a30c5155591644a53c6f319d73604db81bddd207b8d92ce262dbbc3a6","0xb0472d71b514a4d46c487fd98a145179af522e00fd0c2c30d991b043c42cd08e","0x9515373270bdbb30949307103edfbdd99834c9100274b213cd47c1fec145be7b","0x00ee101ebb9fd201dcd9872f446fab5678cef7bb6e4d0c33394394cd49f9a6da","0x97958c5a231957653866725bdf37affc306afad4e6b2970a9634db9a18a4b883","0xe5f5e40ebaaa825580145653981390e89806b124c11fa214f5984b2fb192d057","0x36b2aa26399a5ace0f47ea0f2e5e6bf4fbe4e2087e692f0c3e31f2fff91e329f","0xe97feed43ea1cfca1e150670e790b1de93c138d30e067c647d7a8241b2dc0042","0x8502e27ca52adb62ac919a30ac0c959618ce45c4e7ecc09aabf76efe52fa79a0","0x001d6f5a7af31a83a16ac1e1ffde0f16c9f22b9929c8982e7d5a5c6471aab366","0x88e8c01f1187ee1db7453934c8ad8b4fffd5ca2a51b68ca0d24bccbd3cf22886","0x3f7e0812cf2c2c1a7dc060686b01ba9f4d6c0e9b4464a12dc656ea95278c71b5","0x3c6eb1bd0168bb755274100161d446de17e2c984bf755861e758f2714854890e","0x0184cc375475fe337bee0680826b243827dcc055fd80be37a2ecfee97e852a25","0x708f9b8054cfe9101ec4e21ca470f5a1a2a5658115ef5df397d6e1316c6276fa","0x6d37d7347afd0a5b906158db817945aac50e822719ea315c74fcc22a80763dff","0xb0893c5f885a14c75c686bb20e81c6dc485b86e7c450e2f2da02d4672964518b","0x1a7f33428b89733c48e534b872727aea53dcbd5ac2e6e2df68d4b08a9a1d38fb","0x4844653ebd7b5110f7d4aa7544cd86af42a33e34dfd9eb1108e5586e26f8623e","0xa10093ab38363f72f325bf7deab9afc2ece19f39c7460f30081fc7cf200929b4","0xc77fb725acd25284be3f5719eda9f68e79e127f04185015affd25a39a28ee7f0","0x7a03039ecdcbfb92c92ddbf1059842ddf48e3984c745fb561596ac4102740b89","0xd65efdf46c633c216d7c6505bf86fb58988c9bc395ff715f969f5ae8c809a3bb","0x797b2a6d40061e99dd02719fbdaab674bf9171000035decff67a86bc72a82841","0x05de4fdc8ac58402e2703525625c06e5aaccb4a78a49e6991a56932bb4612737","0xef5e3855c7809c171f0384d2d669aa9977031b19986a8d3f0963a7dfb131a1c0","0x9b4c269b77142857b6a020c8c60be7141764881f8d869a9a6a5a31a6deafec16","0xd1d7804bb22ea9b1f2b848a2717cbdf275d4154c6c9ef8c9c9f79237710192ee","0xb28f92d09cc418d4abd8d469bf6a622468e4a354ff763980762fb75c7bb9185b","0x317d09086ac1b41164ade9e203fff9f429f3d315595cd6745d415c395561d833","0x17d55c6413cee5f4e51108975631edffa135c955b09f076f78555575924f108f","0x33ea52c161b8bb149aa8ec27711424f92177681491b2d938a84d517de2f05fbf","0x68c46afc7435c060c8dd358b757596047b5c14fcc5eeab0b1c13b7bbb3536164","0x57e2926924a346e84854012b2003cdcf0e82965445c2d587bc5d529404a5fb27","0xda8e48942cd21bebb370632e3ba56b08ab796decb4dbc9244fa7deb87176b270","0xc9d7e65d8ac35f22d4f28434622d49c5197ff20b8806affec2ccf45362a93a9a","0xf27ea4a5a24020557d42090bec773fd49c860595bee2dd12c3cc8908acc1a176","0x66470f64c7114d5cd9d10e12be6b75e36f6ce2d674a93e0ac71e680220c7117c","0xf00cef514387dd49950df97e973af3dde7e03a90571672fb7aeea9ead67ec3fa","0x1e2e3da5f3dd1d741fdd7778121e3cec0fd1d52dc6b39f6d5fa1b191e22b2877","0x77684ca5412464e9ad20cb15b0a024b3b2095cffecda553f03896d1fb12b17ab","0x58e1a9de6f62ab052968a0a3d7b0ac7f0230234226092e2bb42b23761406c173","0x4c867be76fae3ac5f3d67ee182a2f80d0e2b2d3eb04f568a0b0c2aeb57baec0a","0xda5be82ac98951f9a497d5cc4662d081bb4158ffacae7af54098a5e7eb8d8f5d","0x66efd65c3ae78e044064fc1f85d0f0c1802baf3bcaeb2ea465e0feb13e716b54","0x45b180f5edfeeb75f8c9908347b7395d33867a10861c0073451dbecc41b5fd48","0xab75d6f0243010dbae096b67abb645d55ab8a6b68e1819dfac7b76ce78bfe9eb","0x43f94b1bf5af6bc4e5b221793ebb761da25938f0f2a54084879a668f8c66cd4a","0xa4770a1c89d9ee3297bc2cfb13bff4792b6f741606899d55236feea92839716d","0x2ad25c9e01696cb65227213953e4ca1d4e5d443e92a65466aacdc6350d7862bb","0xa758e2dfa829bea1421aa302bb038591e35d857d03a5ed567c0de09126dd6aed","0xa77d698a3132296cf43f30eafa8e9b5269ae4ad99f0e47449c2dfae48ec2fcb1","0x895f900a398126d6e4c94ec2939f7033046b62fbf32dc8f2f9b6153847e06618","0xb546d4af6870e10c2232cff2625d00084c349493f015b42427ffafdb795189e6","0x7874e71712dfe592b37b6526914a24968e4db02506005aadafb472b922788ef1","0xbddee718ee25ab064119ffda058b0901cc67ed237bbf4b24aa8353a45da9cab1","0x50b7fddafcec77a2d1df465535cf350dcff3cb7dbdd4a7291ad191b137dd0067","0xe304399860f88225d1a1fd53f7431160677658aa4bac456a27bb068d7bf4dbbc","0x4b0d1f07aec41fbcf3a93da3af4c181910ab4412770bf2d207a7832f82919348","0x028debff83a862bb28614757e0f4eaa26eb3fac2ee90294aa30e8ef121729c9e","0xd7e3e99bbffe7296ae4104aaf34c1d39e80945be5ff64c45a24cf6bbfcc1d3db","0x286306bdd98d1b461856200941280a46ba27b1fe097e34e96741a92beb27a27d","0xaabf193792a0a72ceca96020fbb2720bd8122239552d25d19ef9507c7d8518e5","0x24cb699663cf0a4512f56387eacf79a7f5c7aa9236cb126197ea4351d29419ca","0x942b1a1d3e01948fedb62473ca458d65af7e177200d591cecd450886f5bdac2c","0xbc9162ba47bd0a3dea706af44d8305432d5d1ee83a25071be6a8870137c15ecf","0x48a395f55d5a930cb0b03d86debb5cfb1dd69c79e5045a5446ee3108779986c3","0x6aacfbc4176ca0cdc2f6f4a2e4a75e21b6e8d3054a5a2bb2967effc4ba55d9cd","0xc7b7ef96e60053a265894bca08ce246ac360b12434a418c95d19d6d9ffe1bf0a","0xa65b12cb10e1ce125624a6283030e49f515a9f3fa941c994758593926cf448d1","0xca07cf9841429077f8a41871c4c1cbdb0c16bf700ab6c142c8de8bdf5df61b86","0xf435fe1e1543dc877360adfa8a1d008a194cbe11af1beb4d5c222f5e2ec47085","0xae044f171257022ed5e943a2f1a93a72eef6ede5726388fb58632271f2bd9e23","0x258c20f9125f6f164a2dbd28b79a6e05528e252065578278b98f80bcab37c8c7","0xca32c4339a9bbc03e139a98a803be7efb493e93824256499b2c9d53f8d005207","0xefc3b35bab10fa82016c25a266bcd5488c7e2b0998cf7b6b4e6b43f9c310735b","0x3021b9625cc09e874d441652c0b21e245a5fd80a8429201223e836f296b5301e","0xb2b461c3a008cebd24d88d47c724d4de220b9e83a2a8f0715c2c9f89c234163d","0x88ac7907888968e9479f053d674230e8d694325caa89f00a4cae6fb1b7fd4d7c","0xb139e39af3b5d4040019dfac81d60a58eee474cfb9f89e1533db796a049c3b52","0x75269168a0ca5b265f088b1b135209e70de3e5c178010a2c840cd6fb93a0bd73"],"transactionsRoot":"0x7be1a01d1770b3b487513131475b2f6630c083abf85a3e9579030f94a8d83a3b","uncles":[],"withdrawals":[{"address":"0x39ed68f2087dca23f76792eca8f39508e74d82e5","amount":"0x11502b9","index":"0x282cf76","validatorIndex":"0x12eeef"},{"address":"0xcab62484fe69a44ccf689787f8ad80b003fb6f3b","amount":"0x115cea6","index":"0x282cf77","validatorIndex":"0x12eef0"},{"address":"0x780aa751bcd868205eca94507b184cfe481abcf5","amount":"0xfced6e","index":"0x282cf78","validatorIndex":"0x12eef1"},{"address":"0x780aa751bcd868205eca94507b184cfe481abcf5","amount":"0xfe12a5","index":"0x282cf79","validatorIndex":"0x12eef2"},{"address":"0x780aa751bcd868205eca94507b184cfe481abcf5","amount":"0xfc6e76","index":"0x282cf7a","validatorIndex":"0x12eef3"},{"address":"0x2641c2ded63a0c640629f5edf1189e0f53c06561","amount":"0x1172927","index":"0x282cf7b","validatorIndex":"0x12eef4"},{"address":"0x6be457e04092b28865e0cba84e3b2cfa0f871e67","amount":"0x1172286","index":"0x282cf7c","validatorIndex":"0x12eef5"},{"address":"0x093f6c270ac22ec240f0c6fd7414ea774ca8d3e5","amount":"0x1186273","index":"0x282cf7d","validatorIndex":"0x12eef6"},{"address":"0xd7c612e7b9ed0260b80ab1ab76d63d57390de46e","amount":"0x1145864","index":"0x282cf7e","validatorIndex":"0x12eef7"},{"address":"0xf0b0d3ef9a0a8162abe874b126ee63319384c5f5","amount":"0x114e32e","index":"0x282cf7f","validatorIndex":"0x12eef8"},{"address":"0xb267bbd1c3b0ceafd7e240b192d56c94353b9cfc","amount":"0x1169d8f","index":"0x282cf80","validatorIndex":"0x12eef9"},{"address":"0x7e2a2fa2a064f693f0a55c5639476d913ff12d05","amount":"0x115e152","index":"0x282cf81","validatorIndex":"0x12eefa"},{"address":"0x7e2a2fa2a064f693f0a55c5639476d913ff12d05","amount":"0x1168303","index":"0x282cf82","validatorIndex":"0x12eefb"},{"address":"0xb267bbd1c3b0ceafd7e240b192d56c94353b9cfc","amount":"0x116f065","index":"0x282cf83","validatorIndex":"0x12eefc"},{"address":"0xb267bbd1c3b0ceafd7e240b192d56c94353b9cfc","amount":"0x1169442","index":"0x282cf84","validatorIndex":"0x12eefd"},{"address":"0xb267bbd1c3b0ceafd7e240b192d56c94353b9cfc","amount":"0x1161b73","index":"0x282cf85","validatorIndex":"0x12eefe"}],"withdrawalsRoot":"0xc38fc5f7b04f2c5be9c2d05f3b62287f9bd30821b9d2830d0255aff5335d4cf6"}}"#;

        assert_eq!(res.status(), 200);
        assert_eq!(res.bytes().await.unwrap(), Bytes::from(expected_response));
    }

    #[tokio::test]
    async fn test_switch_provider_middleware_for_json_rpc_get_proof() {
        let providers = vec![
            Url::parse("http://localhost:3500").unwrap(),
            Url::parse("https://docs-demo.quiknode.pro").unwrap(),
        ];

        let http_provider = Http::new_client_with_chain_middleware(
            Url::parse("http://localhost:3500").unwrap(),
            providers,
        );

        let address = "0x7F0d15C7FAae65896648C8273B6d7E43f58Fa842";
        let storage_key =
            vec!["0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421"];
        let block = "0x12c1bc8";

        let params = (address, storage_key, block);

        let payload = Request::new(1, "eth_getProof", params);

        let res = http_provider
            .client()
            .post("http://localhost:3600")
            .json(&payload)
            .send()
            .await
            .unwrap();

        let expected_response = r#"{"jsonrpc":"2.0","result":{"accountProof":["0xf90211a0150327e688d120df647a7d6f23570160b738ce6bae90ed064364e40abbee0adfa04ea4853a22dceade6137e370706d54cb793b81244ad8c8c6fda6355926a88e0ea07e56c07bc332e2e997b6bc66f570fbae6180fa6c097a314ef5cd1ab6063fbf8ea09750be6337f399bfb8dd70168cdde19d835b47fb5ea23462d21bb8c392c7da0da046dbe246082177965ef2ebe23cb2f26f4fd444eb4765cd91663a16d5c7afbe53a0f295175c3a9f620f177b1aa0559bb8850f4ea8938e74cf1c68e5664a6e0ef2dda0e3d21f57a505d289e0542c6c6d8bf2ecbc788051c152be55d2cfcc5e70cc3a1fa0c017476f7d7f84295cb0c1cad7c3a798b082b86ff735e7affb3b66bb928a22afa00d5ddb78587e2d1e29f7355ab7979ece3e87a947a22769c45e060f207fd12ee6a0a178c9e083aaaf531744e504bf0cbee21ebe9b36b9617941d21f8aa940423ef2a0541b2ed1c34fc17eceeb6c16634c2fa1fe48dc64b4de4df28b20e6c0b4a864f2a025f579e25b6842bed5e937f0e0694626d418f0d71c8de9b656c4961c49ad7e59a07cf73f356a94f2d4ad77752a59c945ae5c4674d2bbccd346440e07a7f717323fa07606b9322ec8eb92d403fd60114f0da1d67e11b57b96702c69d24f75df87b76da09fd95e0fc25177d1558ebc8294bac81e6c33745a88850a25131acd0d1648c1c0a0ddb04626721d46cfa46f9c08bacda32d4bcc9db810cfb0fdf5a229d11f45a45280","0xf90211a01db2c4253ebb5d6252976e43dece06db5bc850117f4bf6299169ca0dcf324cfba0bcc2cb7dbcaebec56f958760914849fe4338a65aa9467e2e0a478f4bcc170d75a0a30b0b88ce62861033238ff3609a93d4aaabe70734c617d243a2e92410d9546ea025d1693fdeff038e12fce946f39221e0d2346e20680bc469f716fec2a5babbeea0da08d11e8452cdb37625c79d05b2471ba4a26180ee44cd7876444b97e601a157a07a4bae4d2c21c72f72c3e02fddb329a802e71b67990e9bf8a6b10fe92b9551a3a034e54423084db425dbcbf4dbc0842efc22660f96c8af7f3e4896ee4b76e8d939a016909c6e8fcc1a8b7e4f44c6d3e347995f1115c566165475cffba32deec43045a05e8f083f954cbe25e6a1397e64954fe42fa7391432d0536d32ee2a91741d1731a0bf596afd20edecadd3fbcc1d094a0e6973ff12404f89daf3db7f053f442e7fb9a05dae6182c2b1dd45eb6af1ccfa92500315e9ce66dfb4a75d6349ee92d8265bb5a00e90d24cff617744b0a931b03782e53c871baffab4c8a144edd5e467a4da953ba0859733e555010c7f639802858a0cafed6b13efb686f9d08c1cdc66a20467603da0785ae5adc31d71fd0858a31989a87a5311cadf239fcb5a67aeeb21ff49c7eb20a000e43014c5ec438459c3cb0362a344342c3f981bf676fa93a73b4edb2739e184a099b7c30b2137b08a8c9353d2aba619ed9cb26d25fa4731f8bfdf0198e18bfec980","0xf90211a07ecd0c72d91c44eb8137022040f748db81a564b61db6a0e7d7f20de9700edc3ea08d417e356388fd4392c9d16f151c48c330a3a8ea7a647ed66c5bbb4717e28fa6a068fd62f4eaa595cf53446a432b28d4fbccdc0d17cd00dc3efe15f35d3031f77ca05fcae6ac6dda1f25f252ffeb0024eb2e609036deca41b685fc791bef1649e4eba04505261d96a6aecb8a2bba5dcd5cc36883f3bad959a137bf894e0ef87cc62b57a0729860e354dc2bbad93f401a122b8932fc2ef43e795fe899f4ef09d74649859fa062191a532f95867acdda6bf8488e53614e7259277073f8462a7b5a8e915a2cd2a0b2d0a3d51655ee4eb1060a061f3ae9e8d477cf3ecf7af0a0729a5ede9ebb06d8a0907e7c7a4e3260dda81c81ea18de9a23372db3ea96746c39e8520e24db0cdc8ea0173c065e15ffea7aa8322db37468b51ad7865bbd89b8e01d46dca66185b72f75a07450315836a4217b050e246cdf30b10f855bbdffac34d04eca607be87321f18ba0a73889e77a5b59a9454bb2e4f487ce3e3537c2d35725464a7656d082a24913b9a036d9f682696632713e70d1260525618adca1bc8f24ef4705cf328d731bc6d616a02086b7488394742d2cdb2f8f33d64414a3d032970819f534bbac68202ce66943a0f9b693e3c2b19b621bc69a66cf0d60930789a1129e2e04cb26418f78f209cdaca0b7929f8669876e6d0972a93e51e0c2d33d25b85d53b536ea02b368962a39041580","0xf90211a0bab1b4a698d8c804bc8d470d810c78664b25c9f6cc6675da0c9082de1daf918ca0846375b6ca48a25637b591603458a3236628d19c770ee0947a3171b6d241b99ca0667f089ffefa9e8fc725dc8307e270e9fd49f2a6403820694d1f4589d7d7c333a02ddd388a4dc9588e5baca941a7db6ba530e10dd6d73a5a5bef4c81937d0cdf96a0ce938e1abe68185e5cdc5f39c89f121ee8c0431bbfced73d4e6e3b37154b13e8a035a423d0e75bf31d5e49462e96bb13d9799e54724fc82de1bd53f91551f5cbafa03cc2fda6e7a7d6f3715f749e75cde4c8ac7052f0def31e8680fd7973ece114a8a0754709ed1bcc3a3c6413007a2d37f4044180e21af329d538accf6d2f4aee3e3fa0886bea9f77afb2f67804a36b718a193b202ee5aea69bb70f26211a0c36d4a8fda0f242de96e3e4c99ca26db5c8308a410e4e557bb13260f7ae628905e6431181eda00008f46696107da8e84250ed1a3585e1b1f713de5fbaf3b528a2f28ba7bd9f3da01d21c541e15deba94762969a02da3c6540b94fdd1b24c24cb37fecb70ab0bec8a00553d23762ccfad95b731a7362471b206522b0ad4e5e392adc5ff0baeb3ba450a043fb87de6a54ff0b17253ca894ed30ae79dbae72257242e24f83c9c74755aa81a0275c872d144334b4c8d8384b6abb541d053d8967385df1b13cc806387eec986aa0ab548f9fdeb7b3e650f2990a3e63a53ab075b75f3120e841be4f76d0e70e96b380","0xf90211a062549334dcf5b99889ced16d4baaa7e713dafce8acedec18c769ce3460f8137ea072d4dab9ea194004c7b60ff2936beed0cfcab1f5adfbd6ba2100f91c4dc9b7d5a0400625b200fc94b8eeb607e3d329c2d317121069ee2a552c8c9af3bff9debd6ba0e2a1cbd40f1ce98aa5311bbdde6698b3ab49bb6c1fe764f6599d3e75a430969ba0be59506a861dcdb01b0bbe07ed39b49e9d4189d3f31ae673de4d814b7082778aa0d0a60ad08eb240a82d4d392f224687a2edc41d57f6310d3589b7b3200635af67a06344c0244dc67689c1a57ec6b03ab9b6acbca4e855b2e8d12b3cdf5968671e06a0081555535f0605264bf1add27787c4a1e4285faaac2dc252107a0a3f5bcede6ea009965193e4ab324429cc09c8017d9c6fb4aeaa9c5924f9afaf2955204ff591efa0aac5e238425c6a5a433873961b22d759e94449a96def53a17020d43b02aeb0f0a02d941abe9c2e289eb6bc6812ef7eefef2f7029e6c11b5ddcc9e328e71d210627a072cda18f4d4d95adbdfd7388606f9e35e7a32c1517ea73977947bab8a6edaf37a0dcbcf26f15ad565a47462bb68352a25259cddc5cf6ef510c0a0746313cc4db92a0c017ab648c52b2f739320f4a746ffb0d1c6f1ed2eba60eb16ba8e77f13455edca035098cc47d024862354cc0d0e95a86f8e5ac08dc9671a327e58799e1eec413b4a0668159d6b3da511215e1dda29a25748c0ff24032fefa3381095c883f982d068980","0xf90211a08c2d30cc141aa5f3201e1524c121387e8e4d1713597cd6ee4dff55375f245b3fa0e26dffb503872fa2a3352ca3112d5f039053b3aea5582f6e20f5cf3a97f29e03a015a8f2dd3d6786221c18042e08bff1b8b351ad7b4ec409bbbdcbdc2fe8a41b29a022e931137ea7759f4c5fd042b5f5618666638093375f30186bd61c1209d177dda053e20e9a94b6e5f564d701c0dec3eb6fd8852ff022f5e6ef1249599704b9d2e9a08f8d79f2d5c6d90d6507124d98fce7342e6273bc782c126c451dd3f2c3a34a03a02633d04d2c941ddfe508173ef2607e38d7f9ea726e722aead3444ea123b86bf4a0027b9afd3ce9d53eb766232b9c74604f928e4df7722656fdf5c9ca4cdcd13b2ca0caf457533cc3d7f7048d3594db773d28044f1104b355b57e9522876c7f10d180a0929dfa5f602c173f61dd9313841a4885d98caca40e096084255899d7b751a997a062f60624ce0df2ba7a333a67c4607d5ce548a4609e5d9cc47b67193efd5f0296a0776c41559bf274a9c8ac6a8a37bf58d55d14a4663acb46aaef82d23c76f45e7da033fb2ab64d7013ca0458b692e5cd7e65e65e1d81829912cfafd5150dc9a7ea66a0e5fa432860aab75673fed8ecc114ee1b5ce20ddf3e1dffe95aad11328010a997a0f936dd3857b34105216277a701de61cb265e61c48d704c7c22f8956c75ff59e5a06cdda46bdebf71ee1e18eb0f4ccfa932f62247770a84dd0dea7f2cc37a9c897980","0xf90171a000595129cf1c67ce97ed615df7184fb47a0d018d9147a2a7952a639e464cdfd380a06cdf38906044fbc505fd84a1852f3f8e89a881570933a853934055f75867dd96a0d99cae2bc3b6fc3e8e2767b4d7a5884b9b2d9d20da7890318beefcdb9c7346d58080a0f63571735d99e763dafadb03d1abe3a93a98740ecddc8514d13df46a35a8d946a04b18cd81f7d09a3b8f04b66d3cea2cf1523d8434f9475559206265a9a5fdc3aba081870f4697e57436ccdd8bdc1d624d7bc07861748ff8b3a352334df68f2c03ada0f0252504ee8753335ecf0ca1f73cf13d4505783ed5110bf4e9b384a68ad88f69a0d38a18ef7b993c9ad2d848453e7722c26998ff3d63e243b99cdab0dabf84157ea005aa031ec87523b402d31371cdef7c7f0587907f1f56c3874062bf4b936a7a9480a0bf8371cac505b6ea0cb0f67ef744713f306a2455f3f8844cfa527c62db59c69980a0d6d689405b1cf73786c5fdabb55ec22f9b5712d1ba9c0bfcd46d4b93721fcac780","0xf8669d37f29e142d49f8824d4e7f1735ec3da219687387629b5fccd86812df84b846f8440180a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a01d93f60f105899172f7255c030301c3af4564edd4a48577dbdc448aec7ddb0ac"],"address":"0x7f0d15c7faae65896648c8273b6d7e43f58fa842","balance":"0x0","codeHash":"0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470","nonce":"0x0","storageHash":"0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421","storageProof":[{"key":"0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421","proof":[],"value":"0x00"}]},"id":1}"#;
        assert_eq!(res.status(), 200);
        assert_eq!(res.bytes().await.unwrap(), Bytes::from(expected_response));
    }
}
