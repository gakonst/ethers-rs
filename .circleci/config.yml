version: 2.1

commands:
  setup-lints:
    steps:
      - run:
          name: Install clippy
          command: rustup component add clippy

jobs:
  build:
    docker:
      - image: circleci/rust:latest
    steps:
      - checkout
      - setup-lints
      - run:
          name: Reduce codegen Units
          # If we don't include this, the linker runs out of memory when building
          # the project on CI. We don't include this normally though because
          # it should be able to build with more units on other machines
          command: printf "[profile.dev]\ncodegen-units = 1\n" >> Cargo.toml
      - run:
            name: tests
            # skip these temporarily until we get ganache-cli and solc on CI
            command: cargo test --all -- --skip deploy_and_call_contract --skip send_eth --skip watch_events --skip get_past_events --skip test_pending_tx
      - run:
          name: Check style
          command: |
              cargo fmt --all -- --check
              cargo clippy --all-targets --all-features -- -D warnings
